{% extends 'base.html' %}
{% load widget_tweaks %}

{% block module_name %}ventas{% endblock %}
{% block title %}{% if venta %}Editar Venta{% else %}Nueva Venta{% endif %}{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas {% if venta %}fa-edit{% else %}fa-plus-circle{% endif %}"></i>
        {% if venta %}Editar Venta{% else %}Nueva Venta{% endif %}
    </h1>
    <a href="{% url 'venta_list' %}" class="btn btn-secondary-standard">
        <i class="fas fa-arrow-left"></i> Volver a Ventas
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card card-form">
            <div class="card-body">
                <form method="post" id="ventaForm" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Producto <span class="text-danger">*</span></label>
                            {{ form.id_producto|add_class:"form-select"|attr:"required" }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cliente</label>
                            {{ form.id_cliente|add_class:"form-select" }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Precio Unitario <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">C$</span>
                                {{ form.precio|add_class:"form-control"|attr:"step:0.01"|attr:"required" }}
                            </div>
                            <div class="form-text">Precio por unidad</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cantidad <span class="text-danger">*</span></label>
                            {{ form.cantidad|add_class:"form-control"|attr:"min:1"|attr:"required" }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Total</label>
                            <div class="input-group">
                                <span class="input-group-text">C$</span>
                                <input type="text" class="form-control bg-light" id="totalVenta" 
                                       value="{% if venta %}{{ venta.total|floatformat:2 }}{% else %}0.00{% endif %}" readonly>
                            </div>
                            <div class="form-text">Se calcula automáticamente</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Precio Recomendado</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">C$</span>
                            <input type="text" class="form-control" id="precioRecomendado" readonly>
                        </div>
                        <button type="button" id="usarRecomendado" class="btn btn-outline-primary btn-sm">
                            Usar Precio Recomendado
                        </button>
                    </div>

                    <button type="submit" class="btn btn-primary-standard">
                        <i class="fas fa-save"></i> 
                        {% if venta %}Actualizar Venta{% else %}Guardar Venta{% endif %}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Panel lateral de últimas ventas -->
    <div class="col-lg-4">
        <div class="card card-list">
            <div class="card-header"><h5>Últimas Ventas</h5></div>
            <div class="card-body">
                {% for venta in ultimas_ventas %}
                <div class="d-flex justify-content-between mb-2">
                    <span>{{ venta.id_producto.nombre }}</span>
                    <span>C${{ venta.total|floatformat:2 }} ({{ venta.cantidad }})</span>
                </div>
                {% empty %}
                <small>No hay ventas recientes</small>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Diccionario de precios 
    const preciosRecomendados = {{ precios_recomendados|safe }};

    const productoSelect = document.getElementById('id_id_producto');
    const precioInput = document.getElementById('id_precio');
    const cantidadInput = document.getElementById('id_cantidad');
    const totalInput = document.getElementById('totalVenta');
    const precioRecomendadoInput = document.getElementById('precioRecomendado');
    const usarRecomendadoBtn = document.getElementById('usarRecomendado');

    function actualizarPrecioRecomendado() {
        const productoId = productoSelect.value;
        if (productoId in preciosRecomendados) {
            const recomendado = parseFloat(preciosRecomendados[productoId]) || 0;
            precioRecomendadoInput.value = recomendado.toFixed(2);
        } else {
            precioRecomendadoInput.value = '0.00';
        }
    }

    function calcularTotal() {
        const precio = parseFloat(precioInput.value) || 0;
        const cantidad = parseInt(cantidadInput.value) || 0;
        const total = precio * cantidad;
        totalInput.value = total.toFixed(2);
    }

    function usarPrecioRecomendado() {
        const recomendado = parseFloat(precioRecomendadoInput.value) || 0;
        precioInput.value = recomendado.toFixed(2);
        calcularTotal();
    }

    // Event listeners
    productoSelect.addEventListener('change', actualizarPrecioRecomendado);
    precioInput.addEventListener('input', calcularTotal);
    cantidadInput.addEventListener('input', calcularTotal);
    usarRecomendadoBtn.addEventListener('click', usarPrecioRecomendado);

    // Inicializar
    actualizarPrecioRecomendado();
    calcularTotal();
});
</script>
{% endblock %}